import fs from "node:fs";
import path from "node:path";

/**
 * Parse the palette XML format found under public/pallettes/*.xml
 *
 * We intentionally avoid adding dependencies; the XML files are simple and consistent:
 * <color> ... <name>..</name> <productCode>..</productCode> <brand>..</brand> <red>..</red> <green>..</green> <blue>..</blue> ... </color>
 */

const ROOT = process.cwd();
const SOURCE_XML = path.join(
  ROOT,
  "public",
  "pallettes",
  "unused",
  "_default_pallette_ArtkalFactoryRGBs.xml"
);

const OUT_TS = path.join(ROOT, "src", "lib", "generatedPalettes.ts");

function tagValue(block, tag) {
  const m = block.match(new RegExp(`<${tag}>([\\s\\S]*?)<\\/${tag}>`, "i"));
  return m ? m[1].trim() : "";
}

function parseIntSafe(s) {
  const n = Number.parseInt(String(s), 10);
  return Number.isFinite(n) ? n : 0;
}

function rgbToHex(r, g, b) {
  const clamp = (v) => Math.max(0, Math.min(255, v));
  return (
    "#" +
    [clamp(r), clamp(g), clamp(b)]
      .map((v) => v.toString(16).padStart(2, "0"))
      .join("")
      .toUpperCase()
  );
}

function seriesFromProductCode(productCode) {
  // Extract the leading non-digit prefix, e.g. "P01" -> "P", "S159" -> "S", "H16" -> "H", "C16" -> "C"
  const m = String(productCode).match(/^[^\d]+/);
  return m ? m[0] : "";
}

function parsePaletteXml(xml) {
  const colorBlocks = xml.match(/<color\b[\s\S]*?<\/color>/gi) ?? [];

  // Deduplicate by (brand + productCode). Some sources contain "adjusted" duplicates for the same code.
  // We keep the *last* occurrence to match the common "override" convention in these palette files.
  const byId = new Map();
  for (const block of colorBlocks) {
    const name = tagValue(block, "name");
    const productCode = tagValue(block, "productCode");
    const brand = tagValue(block, "brand");
    const disabled = parseIntSafe(tagValue(block, "disabled"));

    if (!productCode || !brand) continue;
    if (disabled === 1) continue;

    const r = parseIntSafe(tagValue(block, "red"));
    const g = parseIntSafe(tagValue(block, "green"));
    const b = parseIntSafe(tagValue(block, "blue"));
    const hex = rgbToHex(r, g, b);
    const series = seriesFromProductCode(productCode);

    const id = `${brand}:${productCode}`;
    byId.set(id, {
      id,
      name: name || productCode,
      hex,
      brand,
      code: productCode,
      productCode,
      series,
    });
  }

  return Array.from(byId.values());
}

function toTsArray(name, arr) {
  const lines = [];
  lines.push(`export const ${name} = [`);
  for (const c of arr) {
    lines.push(
      `  { id: ${JSON.stringify(c.id)}, name: ${JSON.stringify(
        c.name
      )}, hex: ${JSON.stringify(c.hex)}, brand: ${JSON.stringify(
        c.brand
      )}, code: ${JSON.stringify(c.code)}, productCode: ${JSON.stringify(
        c.productCode
      )}, series: ${JSON.stringify(c.series)} },`
    );
  }
  lines.push(`] as const;`);
  return lines.join("\n");
}

function main() {
  if (!fs.existsSync(SOURCE_XML)) {
    console.error(`Source XML not found: ${SOURCE_XML}`);
    process.exit(1);
  }

  const xml = fs.readFileSync(SOURCE_XML, "utf8");
  const all = parsePaletteXml(xml);

  const perler = all.filter((c) => c.brand === "Perler");
  const artkalS = all.filter((c) => c.brand === "Artkal-S");

  const out = [];
  out.push(`/* AUTO-GENERATED FILE. DO NOT EDIT MANUALLY.`);
  out.push(` *`);
  out.push(
    ` * Source: public/pallettes/unused/_default_pallette_ArtkalFactoryRGBs.xml`
  );
  out.push(` * Generated by: scripts/generate-palettes.mjs`);
  out.push(` */`);
  out.push("");
  out.push(
    `export type GeneratedBeadColor = { id: string; name: string; hex: string; brand: string; code: string; productCode: string; series: string };`
  );
  out.push("");
  out.push(toTsArray("PERLER_PALETTE_FULL", perler));
  out.push("");
  out.push(toTsArray("ARTKAL_S_PALETTE_FULL", artkalS));
  out.push("");

  fs.mkdirSync(path.dirname(OUT_TS), { recursive: true });
  fs.writeFileSync(OUT_TS, out.join("\n") + "\n", "utf8");

  console.log(
    `Generated ${path.relative(ROOT, OUT_TS)} (Perler=${perler.length}, Artkal-S=${artkalS.length})`
  );
}

main();


